generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model advisory_notes {
  note_id         BigInt                         @id @default(autoincrement()) @db.UnsignedBigInt
  student_id      BigInt                         @db.UnsignedBigInt
  class_id        BigInt                         @db.UnsignedBigInt
  advisor_user_id BigInt                         @db.UnsignedBigInt
  warning_id      BigInt?                        @db.UnsignedBigInt
  content         String                         @db.Text
  counseling_date DateTime?                      @db.Date
  handling_status advisory_notes_handling_status @default(not_contacted)
  attachment_url  String?                        @db.VarChar(500)
  created_at      DateTime                       @default(now()) @db.Timestamp(0)
  users           users                          @relation(fields: [advisor_user_id], references: [user_id], map: "fk_notes_advisor")
  classes         classes                        @relation(fields: [class_id], references: [class_id], map: "fk_notes_class")
  students        students                       @relation(fields: [student_id], references: [student_id], onDelete: Cascade, map: "fk_notes_student")
  warnings        warnings?                      @relation(fields: [warning_id], references: [warning_id], map: "fk_notes_warning")

  @@index([advisor_user_id], map: "idx_notes_advisor")
  @@index([class_id], map: "idx_notes_class")
  @@index([handling_status], map: "idx_notes_status")
  @@index([student_id], map: "idx_notes_student")
  @@index([warning_id], map: "idx_notes_warning")
}

model audit_logs {
  log_id      BigInt            @id @default(autoincrement()) @db.UnsignedBigInt
  user_id     BigInt?           @db.UnsignedBigInt
  action      audit_logs_action
  object_type String?           @db.VarChar(50)
  object_id   BigInt?           @db.UnsignedBigInt
  ip_address  String?           @db.VarChar(45)
  details     Json?
  created_at  DateTime          @default(now()) @db.Timestamp(0)
  users       users?            @relation(fields: [user_id], references: [user_id], map: "fk_audit_user")

  @@index([action], map: "idx_audit_action")
  @@index([user_id], map: "idx_audit_user")
}

model class_advisor_assignments {
  assignment_id   BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  class_id        BigInt    @db.UnsignedBigInt
  advisor_user_id BigInt    @db.UnsignedBigInt
  from_date       DateTime  @db.Date
  to_date         DateTime? @db.Date
  is_primary      Boolean   @default(true)
  created_at      DateTime  @default(now()) @db.Timestamp(0)
  users           users     @relation(fields: [advisor_user_id], references: [user_id], map: "fk_assign_advisor")
  classes         classes   @relation(fields: [class_id], references: [class_id], onDelete: Cascade, map: "fk_assign_class")

  @@index([advisor_user_id], map: "idx_assign_advisor")
  @@index([class_id, from_date, to_date], map: "idx_assign_class")
}

model classes {
  class_id                  BigInt                      @id @default(autoincrement()) @db.UnsignedBigInt
  class_code                String                      @unique(map: "uq_classes_code") @db.VarChar(50)
  class_name                String                      @db.VarChar(255)
  major_name                String                      @default("Công nghệ thông tin") @db.VarChar(255)
  cohort_year               Int
  status                    classes_status              @default(active)
  current_advisor_user_id   BigInt?                     @db.UnsignedBigInt
  created_at                DateTime                    @default(now()) @db.Timestamp(0)
  updated_at                DateTime                    @default(now()) @db.Timestamp(0)
  advisory_notes            advisory_notes[]
  class_advisor_assignments class_advisor_assignments[]
  users                     users?                      @relation(fields: [current_advisor_user_id], references: [user_id], map: "fk_classes_current_advisor")
  curriculum_items          curriculum_items[]
  gpa_snapshots             gpa_snapshots[]
  grades                    grades[]
  grading_policies          grading_policies?
  students                  students[]
  warnings                  warnings[]

  @@index([current_advisor_user_id], map: "idx_classes_advisor")
  @@index([cohort_year], map: "idx_classes_cohort")
  @@index([major_name], map: "idx_classes_major")
}

model courses {
  course_id        BigInt              @id @default(autoincrement()) @db.UnsignedBigInt
  course_code      String              @unique(map: "uq_courses_code") @db.VarChar(50)
  course_name      String              @db.VarChar(255)
  credits          Int
  course_type      courses_course_type @default(required)
  is_active        Boolean             @default(true)
  created_at       DateTime            @default(now()) @db.Timestamp(0)
  updated_at       DateTime            @default(now()) @db.Timestamp(0)
  curriculum_items curriculum_items[]
  grades           grades[]

  @@index([is_active], map: "idx_courses_active")
  @@index([credits], map: "idx_courses_credits")
}

model gpa_snapshots {
  snapshot_id                   BigInt                    @id @default(autoincrement()) @db.UnsignedBigInt
  student_id                    BigInt                    @db.UnsignedBigInt
  class_id                      BigInt                    @db.UnsignedBigInt
  semester_id                   BigInt                    @db.UnsignedBigInt
  gpa_semester                  Decimal?                  @db.Decimal(4, 2)
  gpa_cumulative                Decimal?                  @db.Decimal(4, 2)
  credits_attempted_semester    Int                       @default(0)
  credits_earned_semester       Int                       @default(0)
  credits_failed_semester       Int                       @default(0)
  credits_earned_total          Int                       @default(0)
  failed_courses_count_semester Int                       @default(0)
  data_status                   gpa_snapshots_data_status @default(ok)
  created_at                    DateTime                  @default(now()) @db.Timestamp(0)
  updated_at                    DateTime                  @default(now()) @db.Timestamp(0)
  classes                       classes                   @relation(fields: [class_id], references: [class_id], map: "fk_gpa_class")
  semesters                     semesters                 @relation(fields: [semester_id], references: [semester_id], map: "fk_gpa_sem")
  students                      students                  @relation(fields: [student_id], references: [student_id], onDelete: Cascade, map: "fk_gpa_student")

  @@unique([student_id, semester_id], map: "uq_gpa_student_sem")
  @@index([semester_id], map: "fk_gpa_sem")
  @@index([class_id, semester_id], map: "idx_gpa_class_sem")
}

model grade_change_logs {
  change_id        BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  grade_id         BigInt   @db.UnsignedBigInt
  changed_by       BigInt?  @db.UnsignedBigInt
  changed_at       DateTime @default(now()) @db.Timestamp(0)
  old_score_10     Decimal? @db.Decimal(5, 2)
  new_score_10     Decimal? @db.Decimal(5, 2)
  old_letter_grade String?  @db.VarChar(5)
  new_letter_grade String?  @db.VarChar(5)
  old_score_4      Decimal? @db.Decimal(4, 2)
  new_score_4      Decimal? @db.Decimal(4, 2)
  old_is_pass      Boolean?
  new_is_pass      Boolean?
  reason           String?  @db.VarChar(255)
  grades           grades   @relation(fields: [grade_id], references: [grade_id], onDelete: Cascade, map: "fk_grade_change_grade")
  users            users?   @relation(fields: [changed_by], references: [user_id], map: "fk_grade_change_user")

  @@index([changed_by], map: "idx_change_by")
  @@index([grade_id], map: "idx_change_grade")
}

model grades {
  grade_id          BigInt              @id @default(autoincrement()) @db.UnsignedBigInt
  student_id        BigInt              @db.UnsignedBigInt
  class_id          BigInt              @db.UnsignedBigInt
  semester_id       BigInt              @db.UnsignedBigInt
  course_id         BigInt              @db.UnsignedBigInt
  attempt_no        Int                 @default(1)
  score_10          Decimal?            @db.Decimal(5, 2)
  letter_grade      String?             @db.VarChar(5)
  score_4           Decimal?            @db.Decimal(4, 2)
  is_pass           Boolean?
  note              String?             @db.VarChar(255)
  updated_by        BigInt?             @db.UnsignedBigInt
  created_at        DateTime            @default(now()) @db.Timestamp(0)
  updated_at        DateTime            @default(now()) @db.Timestamp(0)
  score_components  Json?
  grading_policy_id BigInt?             @db.UnsignedBigInt
  calculated_at     DateTime?           @db.DateTime(0)
  is_locked         Boolean             @default(false)
  grade_change_logs grade_change_logs[]
  classes           classes             @relation(fields: [class_id], references: [class_id], map: "fk_grades_class")
  courses           courses             @relation(fields: [course_id], references: [course_id], map: "fk_grades_course")
  grading_policies  grading_policies?   @relation(fields: [grading_policy_id], references: [policy_id], map: "fk_grades_policy")
  semesters         semesters           @relation(fields: [semester_id], references: [semester_id], map: "fk_grades_semester")
  students          students            @relation(fields: [student_id], references: [student_id], onDelete: Cascade, map: "fk_grades_student")
  users             users?              @relation(fields: [updated_by], references: [user_id], map: "fk_grades_updated_by")

  @@unique([student_id, semester_id, course_id, attempt_no], map: "uq_grade_unique")
  @@index([semester_id], map: "fk_grades_semester")
  @@index([updated_by], map: "fk_grades_updated_by")
  @@index([class_id, semester_id], map: "idx_grade_class_sem")
  @@index([course_id], map: "idx_grade_course")
  @@index([student_id, semester_id], map: "idx_grade_student_sem")
  @@index([grading_policy_id], map: "fk_grades_policy")
}

model import_batches {
  batch_id    BigInt                     @id @default(autoincrement()) @db.UnsignedBigInt
  import_type import_batches_import_type
  file_name   String                     @db.VarChar(255)
  status      import_batches_status      @default(processing)
  errors_json Json?
  created_by  BigInt?                    @db.UnsignedBigInt
  created_at  DateTime                   @default(now()) @db.Timestamp(0)
  users       users?                     @relation(fields: [created_by], references: [user_id], map: "fk_import_user")

  @@index([created_by], map: "idx_import_created_by")
  @@index([import_type, status], map: "idx_import_status")
}

model password_reset_otps {
  otp_id     BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  user_id    BigInt    @db.UnsignedBigInt
  otp_code   String    @db.VarChar(20)
  expires_at DateTime  @db.DateTime(0)
  used_at    DateTime? @db.DateTime(0)
  created_at DateTime  @default(now()) @db.Timestamp(0)
  users      users     @relation(fields: [user_id], references: [user_id], onDelete: Cascade, map: "fk_otp_user")

  @@index([expires_at], map: "idx_otp_expires")
  @@index([user_id], map: "idx_otp_user")
}

model semesters {
  semester_id   BigInt          @id @default(autoincrement()) @db.UnsignedBigInt
  semester_code String          @unique(map: "uq_semesters_code") @db.VarChar(50)
  name          String          @db.VarChar(255)
  start_date    DateTime        @db.Date
  end_date      DateTime        @db.Date
  is_current    Boolean         @default(false)
  created_at    DateTime        @default(now()) @db.Timestamp(0)
  updated_at    DateTime        @default(now()) @db.Timestamp(0)
  gpa_snapshots gpa_snapshots[]
  grades        grades[]
  warnings      warnings[]

  @@index([is_current], map: "idx_semester_current")
  @@index([start_date, end_date], map: "idx_semester_dates")
}

model students {
  student_id      BigInt                   @id @default(autoincrement()) @db.UnsignedBigInt
  user_id         BigInt?                  @unique(map: "uq_students_user") @db.UnsignedBigInt
  student_code    String                   @unique(map: "uq_students_code") @db.VarChar(50)
  full_name       String                   @db.VarChar(255)
  dob             DateTime?                @db.Date
  gender          students_gender?
  email           String?                  @db.VarChar(255)
  phone           String?                  @db.VarChar(30)
  class_id        BigInt                   @db.UnsignedBigInt
  cohort_year     Int
  major_name      String                   @default("Công nghệ thông tin") @db.VarChar(255)
  academic_status students_academic_status @default(studying)
  created_at      DateTime                 @default(now()) @db.Timestamp(0)
  updated_at      DateTime                 @default(now()) @db.Timestamp(0)
  advisory_notes  advisory_notes[]
  gpa_snapshots   gpa_snapshots[]
  grades          grades[]
  classes         classes                  @relation(fields: [class_id], references: [class_id], map: "fk_students_class")
  users           users?                   @relation(fields: [user_id], references: [user_id], map: "fk_students_user")
  warnings        warnings[]

  @@index([class_id], map: "idx_students_class")
  @@index([academic_status], map: "idx_students_status")
}

model users {
  user_id                                  BigInt                      @id @default(autoincrement()) @db.UnsignedBigInt
  username                                 String                      @unique(map: "uq_users_username") @db.VarChar(100)
  email                                    String?                     @unique(map: "uq_users_email") @db.VarChar(255)
  password_hash                            String                      @db.VarChar(255)
  full_name                                String                      @db.VarChar(255)
  phone                                    String?                     @db.VarChar(30)
  role                                     users_role                  @default(STUDENT)
  status                                   users_status                @default(active)
  failed_login_count                       Int                         @default(0)
  locked_until                             DateTime?                   @db.DateTime(0)
  last_login_at                            DateTime?                   @db.DateTime(0)
  created_at                               DateTime                    @default(now()) @db.Timestamp(0)
  updated_at                               DateTime                    @default(now()) @db.Timestamp(0)
  advisory_notes                           advisory_notes[]
  audit_logs                               audit_logs[]
  class_advisor_assignments                class_advisor_assignments[]
  classes                                  classes[]
  grade_change_logs                        grade_change_logs[]
  grades                                   grades[]
  import_batches                           import_batches[]
  password_reset_otps                      password_reset_otps[]
  students                                 students?
  warning_send_logs                        warning_send_logs[]
  warnings_warnings_acknowledged_byTousers warnings[]                  @relation("warnings_acknowledged_byTousers")
  warnings                                 warnings[]
  warnings_warnings_resolved_byTousers     warnings[]                  @relation("warnings_resolved_byTousers")

  @@index([role], map: "idx_users_role")
  @@index([status], map: "idx_users_status")
}

model warning_rules {
  rule_id         BigInt                       @id @default(autoincrement()) @db.UnsignedBigInt
  rule_code       String                       @unique(map: "uq_rule_code") @db.VarChar(50)
  rule_name       String                       @db.VarChar(255)
  description     String?                      @db.VarChar(500)
  condition_type  warning_rules_condition_type
  operator        warning_rules_operator
  threshold_value Decimal                      @db.Decimal(10, 2)
  level           Int?
  is_active       Boolean                      @default(true)
  created_at      DateTime                     @default(now()) @db.Timestamp(0)
  updated_at      DateTime                     @default(now()) @db.Timestamp(0)
  warnings        warnings[]

  @@index([is_active, condition_type], map: "idx_rule_active")
}

model warnings {
  warning_id                            BigInt                 @id @default(autoincrement()) @db.UnsignedBigInt
  student_id                            BigInt                 @db.UnsignedBigInt
  class_id                              BigInt                 @db.UnsignedBigInt
  semester_id                           BigInt                 @db.UnsignedBigInt
  rule_id                               BigInt                 @db.UnsignedBigInt
  detected_value                        Decimal?               @db.Decimal(10, 2)
  reason_text                           String?                @db.VarChar(500)
  status                                warnings_status        @default(Draft)
  send_channel                          warnings_send_channel?
  send_status                           warnings_send_status?
  send_error                            String?                @db.VarChar(500)
  sent_at                               DateTime?              @db.DateTime(0)
  created_by                            BigInt?                @db.UnsignedBigInt
  created_at                            DateTime               @default(now()) @db.Timestamp(0)
  updated_at                            DateTime               @default(now()) @db.Timestamp(0)
  acknowledged_at                       DateTime?              @db.DateTime(0)
  acknowledged_by                       BigInt?                @db.UnsignedBigInt
  resolved_at                           DateTime?              @db.DateTime(0)
  resolved_by                           BigInt?                @db.UnsignedBigInt
  advisory_notes                        advisory_notes[]
  warning_send_logs                     warning_send_logs[]
  users_warnings_acknowledged_byTousers users?                 @relation("warnings_acknowledged_byTousers", fields: [acknowledged_by], references: [user_id], onUpdate: NoAction, map: "fk_warning_ack_by")
  classes                               classes                @relation(fields: [class_id], references: [class_id], map: "fk_warning_class")
  users                                 users?                 @relation(fields: [created_by], references: [user_id], map: "fk_warning_creator")
  users_warnings_resolved_byTousers     users?                 @relation("warnings_resolved_byTousers", fields: [resolved_by], references: [user_id], onUpdate: NoAction, map: "fk_warning_res_by")
  warning_rules                         warning_rules          @relation(fields: [rule_id], references: [rule_id], map: "fk_warning_rule")
  semesters                             semesters              @relation(fields: [semester_id], references: [semester_id], map: "fk_warning_sem")
  students                              students               @relation(fields: [student_id], references: [student_id], onDelete: Cascade, map: "fk_warning_student")

  @@unique([student_id, semester_id, rule_id], map: "uq_warning_unique")
  @@index([created_by], map: "fk_warning_creator")
  @@index([rule_id], map: "fk_warning_rule")
  @@index([semester_id], map: "fk_warning_sem")
  @@index([class_id, semester_id], map: "idx_warning_class_sem")
  @@index([status], map: "idx_warning_status")
  @@index([acknowledged_by], map: "idx_warning_ack_by")
  @@index([resolved_by], map: "idx_warning_res_by")
}

model warning_send_logs {
  send_log_id  BigInt                    @id @default(autoincrement()) @db.UnsignedBigInt
  warning_id   BigInt                    @db.UnsignedBigInt
  channel      warning_send_logs_channel
  status       warning_send_logs_status
  error        String?                   @db.VarChar(500)
  attempted_by BigInt?                   @db.UnsignedBigInt
  attempted_at DateTime                  @default(now()) @db.Timestamp(0)
  users        users?                    @relation(fields: [attempted_by], references: [user_id], onUpdate: NoAction, map: "fk_sendlog_user")
  warnings     warnings                  @relation(fields: [warning_id], references: [warning_id], onDelete: Cascade, onUpdate: NoAction, map: "fk_sendlog_warning")

  @@index([attempted_by], map: "idx_sendlog_by")
  @@index([attempted_at], map: "idx_sendlog_time")
  @@index([warning_id], map: "idx_sendlog_warning")
}

model curriculum_items {
  item_id     BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  class_id    BigInt   @db.UnsignedBigInt
  course_id   BigInt   @db.UnsignedBigInt
  semester_no Int
  is_required Boolean  @default(true)
  created_at  DateTime @default(now()) @db.Timestamp(0)
  classes     classes  @relation(fields: [class_id], references: [class_id], onDelete: Cascade, onUpdate: NoAction, map: "fk_curriculum_class")
  courses     courses  @relation(fields: [course_id], references: [course_id], onDelete: Cascade, onUpdate: NoAction, map: "fk_curriculum_course")

  @@unique([class_id, course_id], map: "uq_curriculum_class_course")
  @@index([course_id], map: "fk_curriculum_course")
  @@index([class_id, semester_no], map: "idx_curriculum_class_semno")
}

model grading_policies {
  policy_id         BigInt         @id @default(autoincrement()) @db.UnsignedBigInt
  class_id          BigInt         @unique(map: "uq_policy_class") @db.UnsignedBigInt
  pass_score_10     Decimal        @db.Decimal(5, 2)
  created_at        DateTime       @default(now()) @db.Timestamp(0)
  updated_at        DateTime       @default(now()) @db.Timestamp(0)
  pass_score_4      Decimal?       @db.Decimal(4, 2)
  pass_letter_grade String?        @db.VarChar(5)
  allow_retake      Boolean        @default(true)
  max_attempts      Int            @default(3)
  note              String?        @db.VarChar(255)
  grade_scales      grade_scales[]
  grades            grades[]
  classes           classes        @relation(fields: [class_id], references: [class_id], onDelete: Cascade, onUpdate: NoAction, map: "fk_policy_class")
}

model grade_scales {
  scale_id          BigInt           @id @default(autoincrement()) @db.UnsignedBigInt
  grading_policy_id BigInt           @db.UnsignedBigInt
  min_score_10      Decimal          @db.Decimal(5, 2)
  max_score_10      Decimal          @db.Decimal(5, 2)
  letter_grade      String           @db.VarChar(5)
  score_4           Decimal          @db.Decimal(4, 2)
  is_pass           Boolean
  created_at        DateTime         @default(now()) @db.Timestamp(0)
  grading_policies  grading_policies @relation(fields: [grading_policy_id], references: [policy_id], onDelete: Cascade, map: "fk_scale_policy")

  @@index([grading_policy_id], map: "idx_scale_policy")
}

enum import_batches_import_type {
  classes
  students
  grades
  courses
}

enum audit_logs_action {
  EXPORT_REPORT
  IMPORT_DATA
  UPDATE_GRADE
  GENERATE_WARNING
  LOGIN
}

enum import_batches_status {
  processing
  success
  failed
}

enum courses_course_type {
  required
  elective
}

enum warning_rules_condition_type {
  GPA_SEM
  GPA_CUM
  FAIL_COUNT
  CREDITS_EARNED
  CREDITS_FAILED
}

enum classes_status {
  active
  inactive
}

enum students_gender {
  male
  female
  other
}

enum warning_rules_operator {
  LT
  LTE
  GT
  GTE
  EQ
  NEQ
}

enum users_role {
  ADMIN
  ADVISOR
  STUDENT
  SYSTEM
}

enum advisory_notes_handling_status {
  not_contacted
  contacted
  monitoring
  stable
}

enum users_status {
  active
  locked
  inactive
}

enum warnings_status {
  Draft
  Sent
  SendFailed
  Resolved
  Acknowledged
}

enum warnings_send_channel {
  in_app
  email
}

enum warnings_send_status {
  sent
  failed
}

enum gpa_snapshots_data_status {
  ok
  missing_data
}

enum students_academic_status {
  studying
  leave
  dropout
  graduated
}

enum warning_send_logs_channel {
  in_app
  email
}

enum warning_send_logs_status {
  sent
  failed
}
